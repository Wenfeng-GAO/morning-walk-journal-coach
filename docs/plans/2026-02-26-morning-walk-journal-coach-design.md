# 晨间散步交互问答晨记 - 设计文档

- 日期：2026-02-26
- 状态：已评审（待实现）
- 决策摘要：采用方案A（iOS 快捷指令 + 云端 Agent + Markdown 结果页），MVP 仅支持 iPhone，语音链路云端优先，Obsidian Sync 场景下允许一次手动导入。

## 1. 目标与成功标准

### 1.1 目标
构建一个“边走边问”的晨记工具，帮助用户在晨间散步中通过语音完成：
1. 总结前一天的重要事实与进展
2. 反思情绪和决策
3. 形成当天的关键计划

### 1.2 成功标准
1. 单次晨记可在 8-12 分钟完成
2. 输出内容可直接用于复盘，手工改动不超过 3 处
3. 连续 10 次测试流程完成率 >= 90%

## 2. 范围

### 2.1 MVP 包含
1. iPhone 快捷指令入口（口令“开始晨记”）
2. 云端语音转写与对话编排
3. 固定问题框架 + 1~2 层追问
4. 输出 Obsidian 可粘贴 Markdown
5. 打开 Obsidian 后手动一次导入

### 2.2 MVP 不包含
1. Apple Watch 入口
2. Mac 桌面入口
3. 完全自动写回 Obsidian 文件
4. 多用户账号体系

## 3. 架构

1. iOS Shortcut：发起会话、采集语音、提交回答、接收最终 Markdown
2. Session API：维护晨记会话状态（当前问题、追问层级、已答内容）
3. Speech-to-Text：将每轮语音转为文本
4. Dialogue Orchestrator：根据模板推进提问与追问
5. Markdown Composer：将结构化结果渲染为日记 Markdown

## 4. 关键数据流

1. 快捷指令调用 `startSession`，获取第 1 个问题
2. 用户语音回答，快捷指令上传到 `answerTurn`
3. 后端转写后判断：继续追问 or 进入下一主问题
4. 循环至结束，后端输出完整 Markdown
5. 快捷指令复制 Markdown 并拉起 Obsidian 今日笔记，用户手动导入

## 5. 异常处理

1. 网络中断：本轮答案本地缓存，自动重试 2 次
2. 转写失败：提示重录当前轮，已完成轮次不丢失
3. LLM 超时：后端使用模板兜底问题继续流程
4. 会话中断（锁屏/来电）：基于 `session_id` 恢复到未完成问题
5. Markdown 生成失败：降级输出“问答原文 + 粗结构摘要”

## 6. 测试策略

1. 端到端流程测试：10 次真实晨记回放
2. 性能测试：会话启动与每轮响应时延
3. 弱网恢复测试：飞行模式切换与超时重试
4. 模板一致性测试：核心字段与章节完整性校验
5. 回归测试：对话轮次、追问深度、结束条件稳定性

## 7. 风险与缓解

1. 语音噪声导致转写偏差：增加重录入口 + 关键词纠偏
2. 追问过深拉长时长：限制追问深度到 2 层
3. 内容过长难导入：按模板分段输出并控制每段长度
4. 云端服务不稳定：保底固定问答流程，保证可完成性

## 8. 里程碑（MVP）

1. M1：打通快捷指令 + 会话 API 最小闭环
2. M2：接入语音转写与追问编排
3. M3：生成模板化 Markdown 并完成 Obsidian 导入闭环
4. M4：完成稳定性测试并灰度使用
